<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AIæŒ‡æŒ¥èˆ±">
    <title>AI æŒ‡æŒ¥èˆ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-card: #111827;
            --bg-input: #1a2234;
            --border: #1e2d45;
            --text-primary: #e8edf5;
            --text-secondary: #7a8ba8;
            --text-dim: #3a4a60;
            --accent-green: #22c55e;
            --accent-green-dim: #166534;
            --accent-yellow: #eab308;
            --accent-yellow-dim: rgba(234, 179, 8, 0.15);
            --accent-blue: #3b82f6;
            --accent-blue-dim: rgba(59, 130, 246, 0.15);
            --accent-red: #ef4444;
            --accent-red-dim: rgba(239, 68, 68, 0.15);
            --glow-green: rgba(34, 197, 94, 0.15);
            --nav-height: 64px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                linear-gradient(rgba(34, 197, 94, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(34, 197, 94, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .page-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            padding: 16px 16px calc(var(--nav-height) + 24px);
        }

        /* ===== é¡¶éƒ¨ ===== */
        .header { text-align: center; margin-bottom: 20px; padding-top: 8px; }

        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--accent-green), #4ade80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 3px;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .status-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        }

        /* ===== å¡ç‰‡ ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 14px;
        }

        .card-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 14px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== è¡¨å• ===== */
        .input-group { margin-bottom: 12px; }

        .input-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        input[type="text"], select, textarea {
            width: 100%;
            padding: 13px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px var(--glow-green);
        }

        input::placeholder, textarea::placeholder { color: var(--text-dim); }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237a8ba8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }

        /* ===== å†å²è‚¡ç¥¨å€™é€‰ ===== */
        .history-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            min-height: 0;
            transition: all 0.2s;
        }

        .history-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 7px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }

        .history-chip:active {
            transform: scale(0.95);
        }

        .history-chip.selected {
            background: var(--accent-green-dim);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .history-chip .chip-remove {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 11px;
            color: var(--text-dim);
            margin-left: 2px;
        }

        .history-chip .chip-remove:hover {
            color: var(--accent-red);
        }

        .history-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            margin-bottom: 4px;
        }

        .history-label span {
            font-size: 11px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        .history-clear {
            font-size: 11px;
            color: var(--text-dim);
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
        }

        .history-clear:active { color: var(--accent-red); }

        /* ===== æŒ‰é’® ===== */
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Noto Sans SC', sans-serif;
            cursor: pointer;
            transition: transform 0.1s;
            letter-spacing: 1px;
        }

        .btn-primary:active { transform: scale(0.97); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary.loading { background: linear-gradient(135deg, #1a5c32, #145228); pointer-events: none; }

        /* ===== ç›‘æ§åˆ—è¡¨ ===== */
        .monitor-list { list-style: none; }

        .monitor-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 11px 0;
            border-bottom: 1px solid var(--border);
        }

        .monitor-item:last-child { border-bottom: none; }

        .monitor-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 16px;
        }

        .monitor-badge {
            font-size: 11px;
            padding: 3px 9px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge-active { background: var(--accent-green-dim); color: var(--accent-green); }

        .signal-legend {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .legend-tag {
            font-size: 10px;
            padding: 3px 7px;
            border-radius: 5px;
            font-family: 'JetBrains Mono', monospace;
        }

        .tag-left { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .tag-right { background: var(--glow-green); color: var(--accent-green); }
        .tag-br { background: var(--accent-blue-dim); color: var(--accent-blue); }

        /* ===== åº•éƒ¨å¯¼èˆª ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .nav-inner {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 480px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 12px;
            cursor: pointer;
            color: var(--text-dim);
            transition: color 0.2s;
            border: none;
            background: none;
            font-family: 'Noto Sans SC', sans-serif;
        }

        .nav-item.active { color: var(--accent-green); }
        .nav-item .nav-icon { font-size: 20px; }
        .nav-item .nav-label { font-size: 10px; letter-spacing: 0.5px; }
        .nav-item.coming-soon { opacity: 0.35; }

        /* ===== é¡µé¢åˆ‡æ¢ ===== */
        .page { display: none; }
        .page.active { display: block; }

        /* ===== è®¾ç½® ===== */
        .settings-section { margin-bottom: 14px; }

        .help-text {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
            line-height: 1.5;
        }

        .help-text a { color: var(--accent-blue); text-decoration: none; }

        .token-row { display: flex; gap: 8px; }
        .token-row input { flex: 1; }

        .btn-small {
            padding: 13px 16px;
            background: var(--accent-green-dim);
            color: var(--accent-green);
            border: none;
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            font-family: 'Noto Sans SC', sans-serif;
        }

        /* ===== å ä½é¡µé¢ ===== */
        .placeholder { text-align: center; padding: 60px 20px; }
        .placeholder-icon { font-size: 48px; margin-bottom: 16px; }
        .placeholder-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .placeholder-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }

        /* ===== Toast ===== */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 100;
            transition: transform 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast-success { background: var(--accent-green-dim); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .toast-error { background: var(--accent-red-dim); color: var(--accent-red); border: 1px solid var(--accent-red); }

        .version-info {
            text-align: center;
            padding: 16px 0;
            font-size: 11px;
            color: #1e2d45;
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <div class="page-container">

        <div class="header">
            <h1>ğŸš€ AI æŒ‡æŒ¥èˆ±</h1>
            <div class="subtitle">STOCK COMMAND CENTER v2.0</div>
        </div>

        <div class="status-bar">
            <span class="status-dot"></span>
            <span>ç³»ç»Ÿåœ¨çº¿ Â· GitHub Actions</span>
        </div>

        <!-- ===== é¡µé¢1: æŒ‡æŒ¥ä¸­å¿ƒ ===== -->
        <div class="page active" id="page-command">
            <div class="card">
                <div class="card-title">ğŸ“¡ ä»»åŠ¡éƒ¨ç½²</div>
                <div class="input-group">
                    <label>ç›‘æ§ç›®æ ‡ï¼ˆå¤šä¸ªç”¨é€—å·éš”å¼€ï¼‰</label>
                    <input type="text" id="symbolInput" placeholder="AAPL, MSFT, NFLX" autocapitalize="characters">
                    
                    <!-- å†å²å€™é€‰ -->
                    <div id="historySection" style="display:none;">
                        <div class="history-label">
                            <span>ğŸ“Œ å†å²è®°å½• (ç‚¹å‡»é€‰å–)</span>
                            <button class="history-clear" onclick="clearHistory()">æ¸…é™¤å…¨éƒ¨</button>
                        </div>
                        <div class="history-chips" id="historyChips"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>æ‰§è¡Œç­–ç•¥</label>
                    <select id="strategySelect">
                        <option value="triple">ä¸‰é‡ä¿¡å·æ£€æµ‹ï¼ˆå…¨éƒ¨ï¼‰</option>
                        <option value="left">ğŸŸ¡ å·¦ä¾§: å¢é‡æ­¢è·Œå½¢æ€</option>
                        <option value="right">ğŸŸ¢ å³ä¾§: ä¸Šç©¿50æ—¥çº¿</option>
                        <option value="br">ğŸ”µ å³ä¾§: åº•éƒ¨åè½¬(BR)</option>
                    </select>
                </div>
                <button class="btn-primary" id="deployBtn" onclick="deploy()">âš¡ åŒæ­¥åˆ°äº‘ç«¯å¹¶è¿è¡Œ</button>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“‹ å½“å‰ç›‘æ§</div>
                <ul class="monitor-list" id="monitorList">
                    <li class="monitor-item" style="color: var(--text-secondary); font-size: 13px;">å°šæœªéƒ¨ç½²ä»»åŠ¡</li>
                </ul>
                <div class="signal-legend">
                    <span class="legend-tag tag-left">ğŸŸ¡ æ­¢è·Œå½¢æ€</span>
                    <span class="legend-tag tag-right">ğŸŸ¢ ç©¿50æ—¥çº¿</span>
                    <span class="legend-tag tag-br">ğŸ”µ åº•éƒ¨åè½¬</span>
                </div>
            </div>

            <div class="version-info">v2.0 Â· ä¸‰é‡ä¿¡å·æ£€æµ‹</div>
        </div>

        <!-- ===== é¡µé¢2: åˆ†æå™¨ (é¢„ç•™) ===== -->
        <div class="page" id="page-analyze">
            <div class="placeholder">
                <div class="placeholder-icon">ğŸ”¬</div>
                <div class="placeholder-title">è‚¡ç¥¨åˆ†æå™¨</div>
                <div class="placeholder-desc">
                    è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œè‡ªåŠ¨è¿›è¡Œå¤šç»´åº¦åˆ†æ<br>
                    åŸºæœ¬é¢ Â· æŠ€æœ¯é¢ Â· èµ„é‡‘é¢<br><br>
                    ğŸš§ å¼€å‘ä¸­ Â· å³å°†ä¸Šçº¿
                </div>
            </div>
        </div>

        <!-- ===== é¡µé¢3: ç­›é€‰å™¨ (é¢„ç•™) ===== -->
        <div class="page" id="page-screener">
            <div class="placeholder">
                <div class="placeholder-icon">ğŸ¯</div>
                <div class="placeholder-title">æ™ºèƒ½ç­›é€‰å™¨</div>
                <div class="placeholder-desc">
                    æ ¹æ®ç­–ç•¥æ¡ä»¶è‡ªåŠ¨ç­›é€‰æœ€é€‚åˆçš„è‚¡ç¥¨<br>
                    ç­›é€‰å™¨ + ç­–ç•¥èåˆ Â· ä¸€é”®å¼æ“ä½œ<br><br>
                    ğŸš§ å¼€å‘ä¸­ Â· å³å°†ä¸Šçº¿
                </div>
            </div>
        </div>

        <!-- ===== é¡µé¢4: ä¿¡å·è®°å½• (é¢„ç•™) ===== -->
        <div class="page" id="page-signals">
            <div class="placeholder">
                <div class="placeholder-icon">ğŸ“Š</div>
                <div class="placeholder-title">ä¿¡å·è®°å½•</div>
                <div class="placeholder-desc">
                    æŸ¥çœ‹å†å²ä¿¡å· Â· èƒœç‡ç»Ÿè®¡ Â· å›æµ‹ç»“æœ<br>
                    è®°å½•æ¯ä¸€æ¬¡äº¤æ˜“å†³ç­–<br><br>
                    ğŸš§ å¼€å‘ä¸­ Â· å³å°†ä¸Šçº¿
                </div>
            </div>
        </div>

        <!-- ===== é¡µé¢5: è®¾ç½® ===== -->
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-title">ğŸ”‘ GitHub è¿æ¥</div>
                <div class="settings-section">
                    <div class="input-group">
                        <label>Personal Access Token</label>
                        <div class="token-row">
                            <input type="text" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
                            <button class="btn-small" onclick="saveToken()">ä¿å­˜</button>
                        </div>
                        <div class="help-text">
                            <a href="https://github.com/settings/tokens/new" target="_blank">ç‚¹æ­¤åˆ›å»º Token</a>
                            Â· å‹¾é€‰ repo + workflow æƒé™
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ä»“åº“åœ°å€</label>
                        <input type="text" id="repoInput" value="jingxinzhu721212/NFLX_Monitor">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“± é€šçŸ¥è®¾ç½®</div>
                <div class="settings-section">
                    <div class="input-group">
                        <label>Discord Webhook URL</label>
                        <input type="text" id="discordInput" placeholder="https://discord.com/api/webhooks/...">
                        <div class="help-text">å½“å‰é€šçŸ¥é€šè¿‡ Discord æ¨é€</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">âš™ï¸ ç­–ç•¥å‚æ•°</div>
                <div class="settings-section">
                    <div class="input-group">
                        <label>å¢é‡æ­¢è·Œ â€” å›çœ‹å¤©æ•°</label>
                        <input type="text" id="paramLookback" value="20">
                    </div>
                    <div class="input-group">
                        <label>å¢é‡æ­¢è·Œ â€” æœ€ä½è·Œå¹… (%)</label>
                        <input type="text" id="paramDropPct" value="10">
                    </div>
                    <div class="input-group">
                        <label>å¢é‡æ­¢è·Œ â€” æ”¾é‡å€æ•°</label>
                        <input type="text" id="paramVolRatio" value="1.5">
                    </div>
                    <div class="help-text">ä¿®æ”¹å‚æ•°åéœ€é‡æ–°éƒ¨ç½²æ‰ä¼šç”Ÿæ•ˆ</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">â„¹ï¸ å…³äº</div>
                <div class="help-text" style="line-height: 2;">
                    AI æŒ‡æŒ¥èˆ± v2.0<br>
                    ä¸‰é‡ä¿¡å·æ£€æµ‹ç³»ç»Ÿ<br>
                    ğŸŸ¡ å·¦ä¾§: å¢é‡æ­¢è·Œå½¢æ€<br>
                    ğŸŸ¢ å³ä¾§: è‚¡ä»·ä¸Šç©¿50æ—¥å‡çº¿<br>
                    ğŸ”µ å³ä¾§: åº•éƒ¨åè½¬(BR)<br><br>
                    Powered by GitHub Actions + Discord
                </div>
            </div>
        </div>

    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bottom-nav">
        <div class="nav-inner">
            <button class="nav-item active" onclick="switchPage('command', this)">
                <span class="nav-icon">ğŸ“¡</span>
                <span class="nav-label">æŒ‡æŒ¥</span>
            </button>
            <button class="nav-item coming-soon" onclick="switchPage('analyze', this)">
                <span class="nav-icon">ğŸ”¬</span>
                <span class="nav-label">åˆ†æ</span>
            </button>
            <button class="nav-item coming-soon" onclick="switchPage('screener', this)">
                <span class="nav-icon">ğŸ¯</span>
                <span class="nav-label">ç­›é€‰</span>
            </button>
            <button class="nav-item coming-soon" onclick="switchPage('signals', this)">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">ä¿¡å·</span>
            </button>
            <button class="nav-item" onclick="switchPage('settings', this)">
                <span class="nav-icon">âš™ï¸</span>
                <span class="nav-label">è®¾ç½®</span>
            </button>
        </div>
    </nav>

    <div class="toast" id="toast"></div>

    <script>
        // ===== é¡µé¢åˆ‡æ¢ =====
        function switchPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            navEl.classList.add('active');
        }

        // ===== æœ¬åœ°å­˜å‚¨ =====
        function getToken() { return localStorage.getItem('gh_token') || ''; }
        function getRepo() { return document.getElementById('repoInput').value.trim(); }

        // ===== å†å²è‚¡ç¥¨ç®¡ç† =====
        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('symbol_history') || '[]');
            } catch { return []; }
        }

        function saveToHistory(symbols) {
            let history = getHistory();
            symbols.forEach(s => {
                s = s.trim().toUpperCase();
                if (s && !history.includes(s)) {
                    history.unshift(s); // æ–°çš„æ’å‰é¢
                }
            });
            // æœ€å¤šä¿å­˜ 30 ä¸ª
            history = history.slice(0, 30);
            localStorage.setItem('symbol_history', JSON.stringify(history));
            renderHistory();
        }

        function removeFromHistory(symbol) {
            let history = getHistory().filter(s => s !== symbol);
            localStorage.setItem('symbol_history', JSON.stringify(history));
            renderHistory();
        }

        function clearHistory() {
            localStorage.removeItem('symbol_history');
            renderHistory();
        }

        function renderHistory() {
            const history = getHistory();
            const section = document.getElementById('historySection');
            const container = document.getElementById('historyChips');
            const currentInput = document.getElementById('symbolInput').value.toUpperCase();
            const currentSymbols = currentInput.split(',').map(s => s.trim()).filter(s => s);

            if (history.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = history.map(s => {
                const isSelected = currentSymbols.includes(s);
                return `<span class="history-chip ${isSelected ? 'selected' : ''}" onclick="toggleSymbol('${s}')">
                    ${s}
                    <span class="chip-remove" onclick="event.stopPropagation(); removeFromHistory('${s}')">âœ•</span>
                </span>`;
            }).join('');
        }

        function toggleSymbol(symbol) {
            const input = document.getElementById('symbolInput');
            let current = input.value.toUpperCase().split(',').map(s => s.trim()).filter(s => s);

            if (current.includes(symbol)) {
                // å·²é€‰ä¸­ â†’ å–æ¶ˆ
                current = current.filter(s => s !== symbol);
            } else {
                // æœªé€‰ä¸­ â†’ åŠ å…¥
                current.push(symbol);
            }

            input.value = current.join(', ');
            renderHistory(); // åˆ·æ–°é€‰ä¸­çŠ¶æ€
        }

        // ===== åˆå§‹åŒ– =====
        window.addEventListener('DOMContentLoaded', () => {
            const saved = getToken();
            if (saved) document.getElementById('tokenInput').value = saved;

            const lastSymbols = localStorage.getItem('last_symbols');
            if (lastSymbols) {
                document.getElementById('symbolInput').value = lastSymbols;
                updateMonitorList(lastSymbols.split(',').map(s => s.trim()));
            }

            renderHistory();

            // è¾“å…¥æ¡†å˜åŒ–æ—¶åˆ·æ–°é€‰ä¸­çŠ¶æ€
            document.getElementById('symbolInput').addEventListener('input', renderHistory);
        });

        function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (token) {
                localStorage.setItem('gh_token', token);
                showToast('Token å·²ä¿å­˜', 'success');
            }
        }

        // ===== éƒ¨ç½² =====
        async function deploy() {
            const token = getToken();
            const repo = getRepo();
            const symbolStr = document.getElementById('symbolInput').value.trim().toUpperCase();
            const btn = document.getElementById('deployBtn');

            if (!token) {
                showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ GitHub Token', 'error');
                switchPage('settings', document.querySelectorAll('.nav-item')[4]);
                return;
            }

            if (!symbolStr) {
                showToast('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }

            const symbols = symbolStr.split(',').map(s => s.trim()).filter(s => s);
            const configContent = `SYMBOLS = ${JSON.stringify(symbols)}\n`;

            btn.textContent = 'â³ åŒæ­¥ä¸­...';
            btn.classList.add('loading');

            try {
                // 1. è·å– config.py çš„ SHA
                const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/config.py`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const fileData = await fileRes.json();

                // 2. æ›´æ–° config.py
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/config.py`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update monitor: ${symbolStr}`,
                        content: btoa(configContent),
                        sha: fileData.sha
                    })
                });

                if (!updateRes.ok) throw new Error('æ›´æ–° config.py å¤±è´¥');

                // 3. è§¦å‘ workflow
                const wfRes = await fetch(`https://api.github.com/repos/${repo}/actions/workflows/daily_run.yml/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ref: 'main' })
                });

                if (!wfRes.ok && wfRes.status !== 204) throw new Error('è§¦å‘ workflow å¤±è´¥');

                // ä¿å­˜
                localStorage.setItem('last_symbols', symbolStr);
                saveToHistory(symbols); // ä¿å­˜åˆ°å†å²è®°å½•
                updateMonitorList(symbols);
                showToast('âœ… äº‘ç«¯å·²åŒæ­¥ï¼', 'success');

            } catch (err) {
                showToast('âŒ ' + err.message, 'error');
            } finally {
                btn.textContent = 'âš¡ åŒæ­¥åˆ°äº‘ç«¯å¹¶è¿è¡Œ';
                btn.classList.remove('loading');
            }
        }

        // ===== ç›‘æ§åˆ—è¡¨ =====
        function updateMonitorList(symbols) {
            document.getElementById('monitorList').innerHTML = symbols.map(s => `
                <li class="monitor-item">
                    <span class="monitor-symbol">${s}</span>
                    <span class="monitor-badge badge-active">ç›‘æ§ä¸­</span>
                </li>
            `).join('');
        }

        // ===== Toast =====
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast toast-${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
