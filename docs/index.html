<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AIæŒ‡æŒ¥èˆ±">
    <title>AI æŒ‡æŒ¥èˆ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-card: #111827;
            --bg-input: #1a2234;
            --border: #1e2d45;
            --text-primary: #e8edf5;
            --text-secondary: #7a8ba8;
            --text-dim: #3a4a60;
            --accent-green: #22c55e;
            --accent-green-dim: #166534;
            --accent-yellow: #eab308;
            --accent-yellow-dim: rgba(234, 179, 8, 0.15);
            --accent-blue: #3b82f6;
            --accent-blue-dim: rgba(59, 130, 246, 0.15);
            --accent-red: #ef4444;
            --accent-red-dim: rgba(239, 68, 68, 0.15);
            --glow-green: rgba(34, 197, 94, 0.15);
            --nav-height: 64px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                linear-gradient(rgba(34, 197, 94, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(34, 197, 94, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }
        .page-container {
            position: relative; z-index: 1;
            max-width: 480px; margin: 0 auto;
            padding: 16px 16px calc(var(--nav-height) + 24px);
        }
        .header { text-align: center; margin-bottom: 20px; padding-top: 8px; }
        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 22px; font-weight: 700; letter-spacing: 2px;
            background: linear-gradient(135deg, var(--accent-green), #4ade80);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header .subtitle {
            font-size: 11px; color: var(--text-dim); margin-top: 3px;
            font-family: 'JetBrains Mono', monospace; letter-spacing: 1px;
        }
        .status-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 8px; margin-bottom: 20px; font-size: 12px;
            color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;
        }
        .status-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: var(--accent-green); animation: pulse 2s infinite;
        }
        .status-dot.offline { background: var(--accent-yellow); }
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        }
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 18px; margin-bottom: 14px;
        }
        .card-title {
            font-size: 12px; font-weight: 700; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 14px;
            font-family: 'JetBrains Mono', monospace;
        }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 5px; }
        input[type="text"], select {
            width: 100%; padding: 13px 14px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 10px;
            color: var(--text-primary); font-size: 16px;
            font-family: 'JetBrains Mono', monospace; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus { border-color: var(--accent-green); box-shadow: 0 0 0 3px var(--glow-green); }
        input::placeholder { color: var(--text-dim); }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237a8ba8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 14px center; padding-right: 40px;
        }
        .add-row { display: flex; gap: 8px; }
        .add-row input { flex: 1; }
        .btn-add {
            padding: 13px 20px;
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
            border: none; border-radius: 10px; color: #fff;
            font-size: 15px; font-weight: 700; cursor: pointer;
            white-space: nowrap; font-family: 'Noto Sans SC', sans-serif;
            transition: transform 0.1s;
        }
        .btn-add:active { transform: scale(0.95); }
        .history-section { display: none; margin-top: 10px; }
        .history-section.show { display: block; }
        .history-label {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 6px;
        }
        .history-label span { font-size: 11px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
        .history-clear {
            font-size: 11px; color: var(--text-dim); background: none;
            border: none; cursor: pointer; font-family: 'JetBrains Mono', monospace;
        }
        .history-clear:active { color: var(--accent-red); }
        .history-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .history-chip {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 7px 12px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-secondary); font-size: 13px;
            font-family: 'JetBrains Mono', monospace; font-weight: 600;
            cursor: pointer; transition: all 0.15s; user-select: none;
        }
        .history-chip:active { transform: scale(0.95); }
        .history-chip .chip-x {
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%;
            font-size: 11px; color: var(--text-dim); margin-left: 2px;
        }
        .btn-primary {
            width: 100%; padding: 15px;
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
            border: none; border-radius: 12px; color: #fff;
            font-size: 16px; font-weight: 700;
            font-family: 'Noto Sans SC', sans-serif; cursor: pointer;
            transition: transform 0.1s; letter-spacing: 1px;
        }
        .btn-primary:active { transform: scale(0.97); }
        .btn-primary.loading { background: linear-gradient(135deg, #1a5c32, #145228); pointer-events: none; }
        .monitor-list { list-style: none; }
        .monitor-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .monitor-item:last-child { border-bottom: none; }
        .monitor-left { display: flex; align-items: center; gap: 10px; }
        .monitor-symbol { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 16px; }
        .monitor-badge { font-size: 11px; padding: 3px 9px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; }
        .badge-active { background: var(--accent-green-dim); color: var(--accent-green); }
        .btn-remove {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            background: var(--accent-red-dim); border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px; color: var(--accent-red); font-size: 14px; cursor: pointer;
        }
        .btn-remove:active { transform: scale(0.9); background: rgba(239, 68, 68, 0.3); }
        .monitor-empty { color: var(--text-secondary); font-size: 13px; padding: 12px 0; text-align: center; }
        .monitor-count { font-size: 11px; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; margin-bottom: 10px; }
        .signal-legend { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; }
        .legend-tag { font-size: 10px; padding: 3px 7px; border-radius: 5px; font-family: 'JetBrains Mono', monospace; }
        .tag-left { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .tag-right { background: var(--glow-green); color: var(--accent-green); }
        .tag-br { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height); background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(12px); border-top: 1px solid var(--border);
            display: flex; justify-content: center; align-items: center; z-index: 50;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .nav-inner { display: flex; justify-content: space-around; width: 100%; max-width: 480px; }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 3px;
            padding: 6px 12px; cursor: pointer; color: var(--text-dim);
            border: none; background: none; font-family: 'Noto Sans SC', sans-serif;
        }
        .nav-item.active { color: var(--accent-green); }
        .nav-item .nav-icon { font-size: 20px; }
        .nav-item .nav-label { font-size: 10px; letter-spacing: 0.5px; }
        .nav-item.coming-soon { opacity: 0.35; }
        .page { display: none; }
        .page.active { display: block; }
        .settings-section { margin-bottom: 14px; }
        .help-text { font-size: 11px; color: var(--text-secondary); margin-top: 5px; line-height: 1.5; }
        .help-text a { color: var(--accent-blue); text-decoration: none; }
        .token-row { display: flex; gap: 8px; }
        .token-row input { flex: 1; }
        .btn-small {
            padding: 13px 16px; background: var(--accent-green-dim); color: var(--accent-green);
            border: none; border-radius: 10px; font-size: 13px; cursor: pointer;
            white-space: nowrap; font-family: 'Noto Sans SC', sans-serif;
        }
        .placeholder { text-align: center; padding: 60px 20px; }
        .placeholder-icon { font-size: 48px; margin-bottom: 16px; }
        .placeholder-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .placeholder-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
        .toast {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 500;
            z-index: 100; transition: transform 0.3s ease; max-width: 90%; text-align: center;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast-success { background: var(--accent-green-dim); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .toast-error { background: var(--accent-red-dim); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .toast-warning { background: var(--accent-yellow-dim); color: var(--accent-yellow); border: 1px solid var(--accent-yellow); }
        .toast-info { background: var(--accent-blue-dim); color: var(--accent-blue); border: 1px solid var(--accent-blue); }
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.7); z-index: 200;
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 24px; width: 85%; max-width: 340px; text-align: center;
        }
        .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
        .modal-desc { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }
        .modal-desc .modal-symbol { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--accent-red); }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1; padding: 12px; border-radius: 10px; border: none;
            font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Noto Sans SC', sans-serif;
        }
        .modal-btn-cancel { background: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border); }
        .modal-btn-danger { background: var(--accent-red-dim); color: var(--accent-red); border: 1px solid rgba(239, 68, 68, 0.3); }
        .modal-btn:active { transform: scale(0.97); }
        .needs-sync { display: none; align-items: center; gap: 6px; padding: 8px 12px; background: var(--accent-yellow-dim); border: 1px solid rgba(234,179,8,0.3); border-radius: 8px; margin-bottom: 12px; font-size: 12px; color: var(--accent-yellow); }
        .needs-sync.show { display: flex; }
        .version-info { text-align: center; padding: 16px 0; font-size: 11px; color: #1e2d45; font-family: 'JetBrains Mono', monospace; }
        .sync-status {
            font-size: 11px; color: var(--text-dim); text-align: center;
            font-family: 'JetBrains Mono', monospace; margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="header">
            <h1>ğŸš€ AI æŒ‡æŒ¥èˆ±</h1>
            <div class="subtitle">STOCK COMMAND CENTER v2.3</div>
        </div>
        <div class="status-bar">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">æ­£åœ¨è¿æ¥...</span>
        </div>

        <!-- é¡µé¢1: æŒ‡æŒ¥ä¸­å¿ƒ -->
        <div class="page active" id="page-command">
            <div class="card">
                <div class="card-title">â• æ·»åŠ ç›‘æ§</div>
                <div class="input-group">
                    <label>è¾“å…¥æ–°è‚¡ç¥¨ä»£ç ï¼ˆå¤šä¸ªç”¨é€—å·éš”å¼€ï¼‰</label>
                    <div class="add-row">
                        <input type="text" id="symbolInput" placeholder="AAPL, TSLA" autocapitalize="characters">
                        <button class="btn-add" onclick="addSymbols()">æ·»åŠ </button>
                    </div>
                    <div class="history-section" id="historySection">
                        <div class="history-label">
                            <span>ğŸ“Œ æ›¾ç”¨ä»£ç ï¼ˆç‚¹å‡»å¿«é€Ÿæ·»åŠ ï¼‰</span>
                            <button class="history-clear" onclick="clearHistory()">æ¸…é™¤è®°å½•</button>
                        </div>
                        <div class="history-chips" id="historyChips"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>æ‰§è¡Œç­–ç•¥</label>
                    <select id="strategySelect">
                        <option value="triple">ä¸‰é‡ä¿¡å·æ£€æµ‹ï¼ˆå…¨éƒ¨ï¼‰</option>
                        <option value="left">ğŸŸ¡ å·¦ä¾§: å¢é‡æ­¢è·Œå½¢æ€</option>
                        <option value="right">ğŸŸ¢ å³ä¾§: ä¸Šç©¿50æ—¥çº¿</option>
                        <option value="br">ğŸ”µ å³ä¾§: åº•éƒ¨åè½¬(BR)</option>
                    </select>
                </div>
                <div class="needs-sync" id="needsSync">âš ï¸ åˆ—è¡¨å·²å˜æ›´ï¼Œè¯·åŒæ­¥åˆ°äº‘ç«¯</div>
                <button class="btn-primary" id="syncBtn" onclick="syncToCloud()">âš¡ åŒæ­¥åˆ°äº‘ç«¯</button>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“‹ å½“å‰ç›‘æ§</div>
                <div class="sync-status" id="syncStatus"></div>
                <div class="monitor-count" id="monitorCount"></div>
                <ul class="monitor-list" id="monitorList">
                    <li class="monitor-empty">æ­£åœ¨ä»äº‘ç«¯åŠ è½½...</li>
                </ul>
                <div class="signal-legend">
                    <span class="legend-tag tag-left">ğŸŸ¡ æ­¢è·Œå½¢æ€</span>
                    <span class="legend-tag tag-right">ğŸŸ¢ ç©¿50æ—¥çº¿</span>
                    <span class="legend-tag tag-br">ğŸ”µ åº•éƒ¨åè½¬</span>
                </div>
            </div>
            <div class="version-info">v2.3 Â· ä¸‰é‡ä¿¡å·æ£€æµ‹</div>
        </div>

        <!-- é¡µé¢2-4: é¢„ç•™ -->
        <div class="page" id="page-analyze">
            <div class="placeholder">
                <div class="placeholder-icon">ğŸ”¬</div>
                <div class="placeholder-title">è‚¡ç¥¨åˆ†æå™¨</div>
                <div class="placeholder-desc">è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œè‡ªåŠ¨è¿›è¡Œå¤šç»´åº¦åˆ†æ<br>åŸºæœ¬é¢ Â· æŠ€æœ¯é¢ Â· èµ„é‡‘é¢<br><br>ğŸš§ å¼€å‘ä¸­ Â· å³å°†ä¸Šçº¿</div>
            </div>
        </div>
        <div class="page" id="page-screener">
            <div class="placeholder">
                <div class="placeholder-icon">ğŸ¯</div>
                <div class="placeholder-title">æ™ºèƒ½ç­›é€‰å™¨</div>
                <div class="placeholder-desc">æ ¹æ®ç­–ç•¥æ¡ä»¶è‡ªåŠ¨ç­›é€‰æœ€é€‚åˆçš„è‚¡ç¥¨<br>ç­›é€‰å™¨ + ç­–ç•¥èåˆ Â· ä¸€é”®å¼æ“ä½œ<br><br>ğŸš§ å¼€å‘ä¸­ Â· å³å°†ä¸Šçº¿</div>
            </div>
        </div>
        <div class="page" id="page-signals">
            <div class="placeholder">
                <div class="placeholder-icon">ğŸ“Š</div>
                <div class="placeholder-title">ä¿¡å·è®°å½•</div>
                <div class="placeholder-desc">æŸ¥çœ‹å†å²ä¿¡å· Â· èƒœç‡ç»Ÿè®¡ Â· å›æµ‹ç»“æœ<br>è®°å½•æ¯ä¸€æ¬¡äº¤æ˜“å†³ç­–<br><br>ğŸš§ å¼€å‘ä¸­ Â· å³å°†ä¸Šçº¿</div>
            </div>
        </div>

        <!-- é¡µé¢5: è®¾ç½® -->
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-title">ğŸ”‘ GitHub è¿æ¥</div>
                <div class="settings-section">
                    <div class="input-group">
                        <label>Personal Access Token</label>
                        <div class="token-row">
                            <input type="text" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
                            <button class="btn-small" onclick="saveToken()">ä¿å­˜</button>
                        </div>
                        <div class="help-text">
                            <a href="https://github.com/settings/tokens/new" target="_blank">ç‚¹æ­¤åˆ›å»º Token</a> Â· å‹¾é€‰ repo + workflow æƒé™
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ä»“åº“åœ°å€ï¼ˆç­–ç•¥è¿è¡Œçš„ä»“åº“ï¼‰</label>
                        <input type="text" id="repoInput" value="jingxinzhu721212/NFLX_Monitor">
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“± é€šçŸ¥è®¾ç½®</div>
                <div class="settings-section">
                    <div class="input-group">
                        <label>Discord Webhook URL</label>
                        <input type="text" id="discordInput" placeholder="https://discord.com/api/webhooks/...">
                        <div class="help-text">å½“å‰é€šçŸ¥é€šè¿‡ Discord æ¨é€</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">âš™ï¸ ç­–ç•¥å‚æ•°</div>
                <div class="settings-section">
                    <div class="input-group"><label>å¢é‡æ­¢è·Œ â€” å›çœ‹å¤©æ•°</label><input type="text" id="paramLookback" value="20"></div>
                    <div class="input-group"><label>å¢é‡æ­¢è·Œ â€” æœ€ä½è·Œå¹… (%)</label><input type="text" id="paramDropPct" value="10"></div>
                    <div class="input-group"><label>å¢é‡æ­¢è·Œ â€” æ”¾é‡å€æ•°</label><input type="text" id="paramVolRatio" value="1.5"></div>
                    <div class="help-text">ä¿®æ”¹å‚æ•°åéœ€ç‚¹ã€ŒåŒæ­¥åˆ°äº‘ç«¯ã€æ‰ä¼šç”Ÿæ•ˆ</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">â„¹ï¸ å…³äº</div>
                <div class="help-text" style="line-height: 2;">
                    AI æŒ‡æŒ¥èˆ± v2.3<br>ä¸‰é‡ä¿¡å·æ£€æµ‹ç³»ç»Ÿ<br>
                    ğŸŸ¡ å·¦ä¾§: å¢é‡æ­¢è·Œå½¢æ€<br>ğŸŸ¢ å³ä¾§: è‚¡ä»·ä¸Šç©¿50æ—¥å‡çº¿<br>ğŸ”µ å³ä¾§: åº•éƒ¨åè½¬(BR)<br><br>
                    â˜ï¸ æ•°æ®å­˜å‚¨åœ¨ GitHubï¼Œä»»ä½•è®¾å¤‡æ‰“å¼€éƒ½èƒ½åŒæ­¥<br><br>
                    Powered by GitHub Actions + Discord
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-inner">
            <button class="nav-item active" onclick="switchPage('command', this)"><span class="nav-icon">ğŸ“¡</span><span class="nav-label">æŒ‡æŒ¥</span></button>
            <button class="nav-item coming-soon" onclick="switchPage('analyze', this)"><span class="nav-icon">ğŸ”¬</span><span class="nav-label">åˆ†æ</span></button>
            <button class="nav-item coming-soon" onclick="switchPage('screener', this)"><span class="nav-icon">ğŸ¯</span><span class="nav-label">ç­›é€‰</span></button>
            <button class="nav-item coming-soon" onclick="switchPage('signals', this)"><span class="nav-icon">ğŸ“Š</span><span class="nav-label">ä¿¡å·</span></button>
            <button class="nav-item" onclick="switchPage('settings', this)"><span class="nav-icon">âš™ï¸</span><span class="nav-label">è®¾ç½®</span></button>
        </div>
    </nav>

    <div class="toast" id="toast"></div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">ç¡®è®¤åˆ é™¤</div>
            <div class="modal-desc">ç¡®å®šè¦ç§»é™¤ <span class="modal-symbol" id="deleteTarget"></span> å—ï¼Ÿ<br>ç§»é™¤åéœ€åŒæ­¥åˆ°äº‘ç«¯æ‰ä¼šç”Ÿæ•ˆ</div>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        // ===== ç›‘æ§åˆ—è¡¨ =====
        function getSymbols() {
            try { return JSON.parse(localStorage.getItem('monitor_symbols') || '[]'); }
            catch { return []; }
        }
        function saveSymbols(symbols) {
            localStorage.setItem('monitor_symbols', JSON.stringify(symbols));
            renderMonitorList();
            renderHistory();
        }

        // ===== å†å²è®°å½• =====
        function getHistory() {
            try { return JSON.parse(localStorage.getItem('symbol_history') || '[]'); }
            catch { return []; }
        }
        function addToHistory(symbols) {
            var history = getHistory();
            symbols.forEach(function(s) {
                if (s && history.indexOf(s) === -1) { history.unshift(s); }
            });
            history = history.slice(0, 50);
            localStorage.setItem('symbol_history', JSON.stringify(history));
            renderHistory();
        }
        function removeFromHistory(symbol) {
            var history = getHistory().filter(function(s) { return s !== symbol; });
            localStorage.setItem('symbol_history', JSON.stringify(history));
            renderHistory();
        }
        function clearHistory() {
            localStorage.removeItem('symbol_history');
            renderHistory();
        }
        function renderHistory() {
            var history = getHistory();
            var section = document.getElementById('historySection');
            var container = document.getElementById('historyChips');
            var currentList = getSymbols();
            var available = history.filter(function(s) { return currentList.indexOf(s) === -1; });
            if (available.length === 0) { section.classList.remove('show'); return; }
            section.classList.add('show');
            container.innerHTML = available.map(function(s) {
                return '<span class="history-chip" onclick="quickAdd(\'' + s + '\')">' +
                    s +
                    '<span class="chip-x" onclick="event.stopPropagation(); removeFromHistory(\'' + s + '\')">âœ•</span>' +
                '</span>';
            }).join('');
        }
        function quickAdd(symbol) {
            var current = getSymbols();
            if (current.indexOf(symbol) !== -1) return;
            current.push(symbol);
            saveSymbols(current);
            markDirty();
            showToast('âœ… å·²æ·»åŠ  ' + symbol, 'success');
        }

        // ===== é¡µé¢åˆ‡æ¢ =====
        function switchPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
            document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
            document.getElementById('page-' + pageId).classList.add('active');
            navEl.classList.add('active');
        }

        // ===== Token & Repo =====
        function getToken() { return localStorage.getItem('gh_token') || ''; }
        function getRepo() { return document.getElementById('repoInput').value.trim(); }
        function saveToken() {
            var token = document.getElementById('tokenInput').value.trim();
            if (token) {
                localStorage.setItem('gh_token', token);
                showToast('Token å·²ä¿å­˜ï¼Œæ­£åœ¨åŒæ­¥...', 'success');
                fetchFromCloud(); // ä¿å­˜ token åç«‹å³æ‹‰å–
            }
        }

        // ===== åŒæ­¥æé†’ =====
        function markDirty() { document.getElementById('needsSync').classList.add('show'); }
        function markClean() { document.getElementById('needsSync').classList.remove('show'); }

        // ===== ä»äº‘ç«¯æ‹‰å– config.py =====
        async function fetchFromCloud() {
            var token = getToken();
            var repo = getRepo();
            var dot = document.getElementById('statusDot');
            var text = document.getElementById('statusText');
            var syncStatus = document.getElementById('syncStatus');

            if (!token) {
                dot.classList.add('offline');
                text.textContent = 'æœªè¿æ¥ Â· è¯·å…ˆè®¾ç½® Token';
                syncStatus.textContent = '';
                renderMonitorList();
                return;
            }

            try {
                var res = await fetch('https://api.github.com/repos/' + repo + '/contents/config.py', {
                    headers: { 'Authorization': 'token ' + token }
                });

                if (!res.ok) throw new Error('æ— æ³•è¯»å–');

                var data = await res.json();
                var content = atob(data.content);

                // è§£æ SYMBOLS = ["NFLX", "UNH", ...]
                var match = content.match(/SYMBOLS\s*=\s*\[([^\]]*)\]/);
                if (match) {
                    var symbolStr = match[1];
                    var symbols = [];
                    var re = /["']([^"']+)["']/g;
                    var m;
                    while ((m = re.exec(symbolStr)) !== null) {
                        symbols.push(m[1].trim().toUpperCase());
                    }

                    saveSymbols(symbols);
                    addToHistory(symbols);

                    dot.classList.remove('offline');
                    text.textContent = 'ç³»ç»Ÿåœ¨çº¿ Â· GitHub Actions';
                    syncStatus.textContent = 'â˜ï¸ å·²ä»äº‘ç«¯åŒæ­¥ Â· ' + new Date().toLocaleTimeString();
                    markClean();
                } else {
                    throw new Error('config.py æ ¼å¼å¼‚å¸¸');
                }
            } catch (err) {
                dot.classList.add('offline');
                text.textContent = 'åŒæ­¥å¤±è´¥ Â· ' + err.message;
                syncStatus.textContent = '';
                // ä»ç„¶æ˜¾ç¤ºæœ¬åœ°æ•°æ®
                renderMonitorList();
            }
        }

        // ===== æ·»åŠ è‚¡ç¥¨ =====
        function addSymbols() {
            var input = document.getElementById('symbolInput');
            var newStr = input.value.trim().toUpperCase();
            if (!newStr) { showToast('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error'); return; }

            var newSymbols = newStr.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return /^[A-Z]{1,5}$/.test(s); });
            if (newSymbols.length === 0) { showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç ', 'error'); return; }

            var current = getSymbols();
            var addedCount = 0;
            newSymbols.forEach(function(s) {
                if (current.indexOf(s) === -1) { current.push(s); addedCount++; }
            });

            if (addedCount === 0) { showToast('è¿™äº›è‚¡ç¥¨å·²åœ¨ç›‘æ§åˆ—è¡¨ä¸­', 'warning'); return; }

            saveSymbols(current);
            addToHistory(newSymbols);
            input.value = '';
            markDirty();
            showToast('âœ… å·²æ·»åŠ  ' + addedCount + ' åªè‚¡ç¥¨', 'success');
        }

        // ===== åˆ é™¤è‚¡ç¥¨ =====
        var pendingDeleteSymbol = null;
        function requestDelete(symbol) {
            pendingDeleteSymbol = symbol;
            document.getElementById('deleteTarget').textContent = symbol;
            document.getElementById('deleteModal').classList.add('show');
        }
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            pendingDeleteSymbol = null;
        }
        function confirmDelete() {
            if (!pendingDeleteSymbol) return;
            var removed = pendingDeleteSymbol;
            var current = getSymbols().filter(function(s) { return s !== removed; });
            saveSymbols(current);
            addToHistory([removed]);
            closeDeleteModal();
            markDirty();
            showToast('ğŸ—‘ï¸ å·²ç§»é™¤ ' + removed, 'success');
        }

        // ===== æ¸²æŸ“ç›‘æ§åˆ—è¡¨ =====
        function renderMonitorList() {
            var symbols = getSymbols();
            var list = document.getElementById('monitorList');
            var count = document.getElementById('monitorCount');
            if (symbols.length === 0) {
                list.innerHTML = '<li class="monitor-empty">å°šæœªæ·»åŠ è‚¡ç¥¨</li>';
                count.textContent = '';
                return;
            }
            count.textContent = 'å…± ' + symbols.length + ' åª';
            list.innerHTML = symbols.map(function(s) {
                return '<li class="monitor-item">' +
                    '<div class="monitor-left">' +
                        '<span class="monitor-symbol">' + s + '</span>' +
                        '<span class="monitor-badge badge-active">ç›‘æ§ä¸­</span>' +
                    '</div>' +
                    '<button class="btn-remove" onclick="requestDelete(\'' + s + '\')" title="ç§»é™¤ ' + s + '">ğŸ—‘ï¸</button>' +
                '</li>';
            }).join('');
        }

        // ===== åŒæ­¥åˆ°äº‘ç«¯ =====
        async function syncToCloud() {
            var token = getToken();
            var repo = getRepo();
            var symbols = getSymbols();
            var btn = document.getElementById('syncBtn');

            if (!token) {
                showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ GitHub Token', 'error');
                switchPage('settings', document.querySelectorAll('.nav-item')[4]);
                return;
            }
            if (symbols.length === 0) {
                showToast('ç›‘æ§åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ è‚¡ç¥¨', 'error');
                return;
            }

            var configContent = 'SYMBOLS = ' + JSON.stringify(symbols) + '\n';
            btn.textContent = 'â³ åŒæ­¥ä¸­...';
            btn.classList.add('loading');

            try {
                var fileRes = await fetch('https://api.github.com/repos/' + repo + '/contents/config.py', {
                    headers: { 'Authorization': 'token ' + token }
                });
                var fileData = await fileRes.json();

                var updateRes = await fetch('https://api.github.com/repos/' + repo + '/contents/config.py', {
                    method: 'PUT',
                    headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Update monitor: ' + symbols.join(', '),
                        content: btoa(configContent),
                        sha: fileData.sha
                    })
                });
                if (!updateRes.ok) throw new Error('æ›´æ–° config.py å¤±è´¥');

                var wfRes = await fetch('https://api.github.com/repos/' + repo + '/actions/workflows/daily_run.yml/dispatches', {
                    method: 'POST',
                    headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ref: 'main' })
                });
                if (!wfRes.ok && wfRes.status !== 204) throw new Error('è§¦å‘ workflow å¤±è´¥');

                markClean();
                document.getElementById('syncStatus').textContent = 'â˜ï¸ å·²åŒæ­¥ Â· ' + new Date().toLocaleTimeString();
                showToast('âœ… äº‘ç«¯å·²åŒæ­¥ï¼', 'success');
            } catch (err) {
                showToast('âŒ ' + err.message, 'error');
            } finally {
                btn.textContent = 'âš¡ åŒæ­¥åˆ°äº‘ç«¯';
                btn.classList.remove('loading');
            }
        }

        // ===== åˆå§‹åŒ– =====
        window.addEventListener('DOMContentLoaded', function() {
            var saved = getToken();
            if (saved) document.getElementById('tokenInput').value = saved;

            // æ ¸å¿ƒï¼šå¯åŠ¨æ—¶ä»äº‘ç«¯æ‹‰å–æœ€æ–°æ•°æ®
            fetchFromCloud();

            document.getElementById('symbolInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); addSymbols(); }
            });
        });

        // ===== Toast =====
        function showToast(msg, type) {
            var t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast toast-' + type + ' show';
            setTimeout(function() { t.classList.remove('show'); }, 3000);
        }
    </script>
</body>
</html>
